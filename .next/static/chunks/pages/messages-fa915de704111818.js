(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[313],{4755:function(e,r,s){(window.__NEXT_P=window.__NEXT_P||[]).push(["/messages",function(){return s(5113)}])},5113:function(e,r,s){"use strict";s.r(r),s.d(r,{default:function(){return Messages}});var t=s(5893),a=s(7294),o=s(1163),n=s(1955),l=s(7435),c=s(4423),i=s(8122),d=s(6893),u=s(5380);function Messages(){let{theme:e}=(0,u.F)(),[r,s]=(0,a.useState)(null),[m,x]=(0,a.useState)([]),[h,y]=(0,a.useState)(null),[g,f]=(0,a.useState)([]),[p,v]=(0,a.useState)(""),[b,j]=(0,a.useState)(""),[N,k]=(0,a.useState)([]),[w,C]=(0,a.useState)(!1),[E,M]=(0,a.useState)(!0),[S,L]=(0,a.useState)(!1),T=(0,o.useRouter)();(0,a.useEffect)(()=>{let e=n.Z.get("token"),r=n.Z.get("username");if(!e||!r){T.push("/");return}s(r),checkBanStatus(),fetchConversations(),T.query.user&&"string"==typeof T.query.user&&(y(T.query.user),fetchMessages(T.query.user))},[T.query]);let checkBanStatus=async()=>{try{let e=n.Z.get("token");if(!e)return;let r=await fetch("https://api.tusecreto.net/api/announcements/ban-status",{headers:{Authorization:"Bearer ".concat(e)}});if(r.ok){let e=await r.json();e.isBanned&&L(!0)}}catch(e){console.error("Error checking ban status:",e)}},fetchConversations=async()=>{try{let e=n.Z.get("token");if(!e)return;let r=await fetch("https://api.tusecreto.net/api/messages/conversations",{headers:{Authorization:"Bearer ".concat(e)}});if(r.ok){let e=await r.json();x(e)}}catch(e){console.error("Error fetching conversations:",e)}finally{M(!1)}},fetchMessages=async e=>{try{let s=n.Z.get("token");if(!s)return;let t=await fetch("/api/messages/conversation/".concat(e),{headers:{Authorization:"Bearer ".concat(s)}});if(t.ok){let e=await t.json();f(e);let s=e.filter(e=>e.receiver===r&&!e.isRead);for(let e of s)await markAsRead(e.id)}}catch(e){console.error("Error fetching messages:",e)}},markAsRead=async e=>{try{let r=n.Z.get("token");if(!r)return;await fetch("/api/messages/".concat(e,"/read"),{method:"PATCH",headers:{Authorization:"Bearer ".concat(r)}})}catch(e){console.error("Error marking message as read:",e)}},sendMessage=async()=>{if(p.trim()&&h)try{let e=n.Z.get("token");if(!e)return;let r=await fetch("https://api.tusecreto.net/api/messages/send",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(e)},body:JSON.stringify({receiver:h,content:p.trim()})});if(r.ok)v(""),fetchMessages(h),fetchConversations();else{let e=await r.json();alert(e.message||"Error enviando mensaje")}}catch(e){console.error("Error sending message:",e),alert("Error enviando mensaje")}},searchUsers=async e=>{if(!e||e.length<2){k([]);return}try{let r=n.Z.get("token");if(!r)return;let s=await fetch("/api/profiles/search/".concat(encodeURIComponent(e)),{headers:{Authorization:"Bearer ".concat(r)}});if(s.ok){let e=await s.json();k(e)}}catch(e){console.error("Error searching users:",e)}},startConversation=e=>{y(e),C(!1),j(""),k([]),fetchMessages(e)},reportMessage=async e=>{let r=prompt("\xbfPor qu\xe9 quieres reportar este mensaje?");if(r)try{let s=n.Z.get("token");if(!s)return;let t=await fetch("/api/messages/".concat(e,"/report"),{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(s)},body:JSON.stringify({reason:r})});if(t.ok)alert("Mensaje reportado exitosamente");else{let e=await t.json();alert(e.message||"Error reportando mensaje")}}catch(e){console.error("Error reporting message:",e),alert("Error reportando mensaje")}},handleLogin=()=>{T.push("/")},handleLogout=()=>{n.Z.remove("token"),n.Z.remove("username"),T.push("/")};return((0,a.useEffect)(()=>{if(b){let e=setTimeout(()=>{searchUsers(b)},300);return()=>clearTimeout(e)}k([])},[b]),S)?(0,t.jsx)(c.Z,{}):E?(0,t.jsx)(l.Z,{user:r,onLogin:handleLogin,onLogout:handleLogout,children:(0,t.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 mx-auto",style:{borderColor:"var(--accent)"}}),(0,t.jsx)("p",{className:"mt-4",style:{color:"var(--text-secondary)"},children:"Cargando mensajes..."})]})})}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.Z,{title:"Mensajes Privados An\xf3nimos",description:"Env\xeda y recibe mensajes privados de forma completamente an\xf3nima. Conecta con otros usuarios sin revelar tu identidad.",keywords:"mensajes an\xf3nimos, chat privado, mensajer\xeda segura, comunicaci\xf3n an\xf3nima",url:"https://secretos.tusecreto.net/messages",noindex:!0}),(0,t.jsx)(l.Z,{user:r,onLogin:handleLogin,onLogout:handleLogout,children:(0,t.jsxs)("div",{className:"max-w-7xl mx-auto px-4 py-6",children:[(0,t.jsx)("div",{className:"mb-6",children:(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("h1",{className:"text-2xl font-bold",style:{color:"var(--text-primary)"},children:"Mensajes"}),(0,t.jsx)("p",{className:"text-sm",style:{color:"var(--text-secondary)"},children:"Conversaciones privadas"})]}),(0,t.jsxs)("button",{onClick:()=>C(!w),className:"px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200 border",style:{backgroundColor:"var(--bg-secondary)",borderColor:"var(--border-primary)",color:"var(--text-primary)"},onMouseEnter:r=>{r.currentTarget.style.backgroundColor="dark"===e?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.05)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="var(--bg-secondary)"},children:[(0,t.jsx)(d.jRj,{className:"w-4 h-4 mr-2 inline"}),"Nuevo chat"]})]})}),(0,t.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]",children:[(0,t.jsx)("div",{className:"".concat(h?"hidden lg:block":"block"," rounded-lg border overflow-hidden"),style:{backgroundColor:"var(--bg-secondary)",borderColor:"var(--border-primary)"},children:(0,t.jsxs)("div",{className:"flex flex-col h-full",children:[w&&(0,t.jsxs)("div",{className:"p-4 border-b",style:{borderColor:"var(--border-primary)"},children:[(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)(d.jRj,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4",style:{color:"var(--text-tertiary)"}}),(0,t.jsx)("input",{type:"text",placeholder:"Buscar usuarios...",value:b,onChange:e=>j(e.target.value),className:"w-full pl-10 pr-4 py-2 rounded-md border transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500",style:{backgroundColor:"var(--bg-primary)",borderColor:"var(--border-primary)",color:"var(--text-primary)"}})]}),N.length>0&&(0,t.jsx)("div",{className:"mt-3 rounded-md border shadow-sm max-h-48 overflow-y-auto",style:{backgroundColor:"var(--bg-primary)",borderColor:"var(--border-primary)"},children:N.map(r=>(0,t.jsx)("button",{onClick:()=>startConversation(r.username),className:"w-full p-3 text-left transition-colors duration-200 border-b last:border-b-0",style:{borderColor:"var(--border-primary)"},onMouseEnter:r=>{r.currentTarget.style.backgroundColor="dark"===e?"rgba(255, 255, 255, 0.05)":"rgba(0, 0, 0, 0.02)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="transparent"},children:(0,t.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,t.jsx)("div",{className:"w-8 h-8 rounded-full flex items-center justify-center",style:{backgroundColor:"var(--bg-tertiary)"},children:(0,t.jsx)(d.fzv,{className:"w-4 h-4",style:{color:"var(--text-tertiary)"}})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"font-medium truncate",style:{color:"var(--text-primary)"},children:r.username}),r.bio&&(0,t.jsx)("p",{className:"text-xs truncate",style:{color:"var(--text-tertiary)"},children:r.bio}),!r.allowPrivateMessages&&(0,t.jsx)("p",{className:"text-xs text-red-500",children:"No acepta mensajes"})]})]})},r.username))})]}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto",children:0===m.length?(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center h-full p-8 text-center",children:[(0,t.jsx)(d.EQ9,{className:"w-12 h-12 mb-4",style:{color:"var(--text-tertiary)"}}),(0,t.jsx)("h3",{className:"text-lg font-medium mb-2",style:{color:"var(--text-primary)"},children:"No hay conversaciones"}),(0,t.jsx)("p",{style:{color:"var(--text-secondary)"},children:"Busca usuarios para empezar a chatear"})]}):(0,t.jsx)("div",{children:m.map(r=>(0,t.jsx)("button",{onClick:()=>{y(r.user),fetchMessages(r.user)},className:"w-full p-4 text-left transition-colors duration-200 border-b",style:{borderColor:"var(--border-primary)",backgroundColor:h===r.user?"dark"===e?"rgba(255, 255, 255, 0.05)":"rgba(0, 0, 0, 0.02)":"transparent"},onMouseEnter:s=>{h!==r.user&&(s.currentTarget.style.backgroundColor="dark"===e?"rgba(255, 255, 255, 0.03)":"rgba(0, 0, 0, 0.01)")},onMouseLeave:e=>{h!==r.user&&(e.currentTarget.style.backgroundColor="transparent")},children:(0,t.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,t.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0",style:{backgroundColor:"var(--bg-tertiary)"},children:(0,t.jsx)(d.fzv,{className:"w-5 h-5",style:{color:"var(--text-tertiary)"}})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between",children:[(0,t.jsx)("p",{className:"font-medium truncate",style:{color:"var(--text-primary)"},children:r.user}),(0,t.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,t.jsx)("p",{className:"text-xs",style:{color:"var(--text-tertiary)"},children:new Date(r.lastMessage.createdAt).toLocaleDateString()}),r.unreadCount>0&&(0,t.jsx)("span",{className:"inline-flex items-center justify-center w-5 h-5 text-xs font-medium text-white bg-red-500 rounded-full",children:r.unreadCount})]})]}),(0,t.jsx)("p",{className:"text-sm truncate mt-1",style:{color:"var(--text-secondary)"},children:r.lastMessage.content})]})]})},r.user))})})]})}),(0,t.jsx)("div",{className:"".concat(h?"flex":"hidden lg:flex"," lg:col-span-2 flex-col rounded-lg border overflow-hidden"),style:{backgroundColor:"var(--bg-secondary)",borderColor:"var(--border-primary)"},children:h?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"flex items-center justify-between p-4 border-b",style:{borderColor:"var(--border-primary)"},children:(0,t.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,t.jsx)("button",{onClick:()=>y(null),className:"lg:hidden p-2 rounded-md transition-colors duration-200",style:{color:"var(--text-secondary)"},onMouseEnter:r=>{r.currentTarget.style.backgroundColor="dark"===e?"rgba(255, 255, 255, 0.1)":"rgba(0, 0, 0, 0.05)"},onMouseLeave:e=>{e.currentTarget.style.backgroundColor="transparent"},children:(0,t.jsx)(d.Ao2,{className:"w-5 h-5"})}),(0,t.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center",style:{backgroundColor:"var(--bg-tertiary)"},children:(0,t.jsx)(d.fzv,{className:"w-5 h-5",style:{color:"var(--text-tertiary)"}})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"font-semibold",style:{color:"var(--text-primary)"},children:h}),(0,t.jsx)("button",{onClick:()=>T.push("/profiles/".concat(h)),className:"text-sm hover:underline transition-colors duration-200",style:{color:"var(--text-secondary)"},children:"Ver perfil"})]})]})}),(0,t.jsx)("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:g.map(e=>(0,t.jsx)("div",{className:"flex ".concat(e.sender===r?"justify-end":"justify-start"),children:(0,t.jsxs)("div",{className:"max-w-[70%] p-3 rounded-lg relative group ".concat(e.sender===r?"bg-blue-500 text-white":""),style:e.sender!==r?{backgroundColor:"var(--bg-tertiary)",color:"var(--text-primary)"}:{},children:[(0,t.jsx)("p",{className:"break-words",children:e.content}),(0,t.jsxs)("p",{className:"text-xs mt-1 opacity-70 ".concat(e.sender===r?"text-right":"text-left"),children:[new Date(e.createdAt).toLocaleTimeString(),e.sender===r&&(0,t.jsx)("span",{className:"ml-2",children:e.isRead?(0,t.jsx)(d.rDJ,{size:12}):"â—"})]}),e.sender!==r&&(0,t.jsx)("button",{onClick:()=>reportMessage(e.id),className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity p-1 rounded",style:{backgroundColor:"rgba(255, 255, 255, 0.1)",color:"var(--text-primary)"},children:(0,t.jsx)(d.BJv,{size:12})})]})},e.id))}),(0,t.jsxs)("div",{className:"p-4 border-t",style:{borderColor:"var(--border-primary)"},children:[(0,t.jsxs)("div",{className:"flex gap-2",children:[(0,t.jsx)("input",{type:"text",placeholder:"Escribe un mensaje...",value:p,onChange:e=>v(e.target.value),onKeyPress:e=>"Enter"===e.key&&sendMessage(),maxLength:500,className:"flex-1 px-4 py-2 rounded-lg border transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500",style:{backgroundColor:"var(--bg-primary)",borderColor:"var(--border-primary)",color:"var(--text-primary)"}}),(0,t.jsx)("button",{onClick:sendMessage,disabled:!p.trim(),className:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed transition-colors duration-200",children:(0,t.jsx)(d.LbG,{size:16})})]}),(0,t.jsxs)("p",{className:"text-xs mt-1",style:{color:"var(--text-tertiary)"},children:[p.length,"/500 caracteres"]})]})]}):(0,t.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)(d.EQ9,{size:64,className:"mx-auto mb-4",style:{color:"var(--text-tertiary)"}}),(0,t.jsx)("h3",{className:"text-xl font-bold mb-2",style:{color:"var(--text-primary)"},children:"Selecciona una conversaci\xf3n"}),(0,t.jsx)("p",{style:{color:"var(--text-secondary)"},children:"Elige una conversaci\xf3n existente o busca un usuario para comenzar a chatear"})]})})})]})]})})]})}}},function(e){e.O(0,[415,917,435,869,774,888,179],function(){return e(e.s=4755)}),_N_E=e.O()}]);